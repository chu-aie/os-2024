# 데이터 무결성과 보호

## 디스크 오류 모델

RAID를 다뤘던 장에서 배웠듯이, 디스크는 완전하지 않으며 (때에 따라) 오류가 발생할 수 있습니다. 초기 RAID 시스템에서는 오류 모델이 간단한 편이었습니다.  디스크 전체가 동작하던가, 또는 완전히 불능이기 때문에 그러한 오류를 단순하게 판단할 수 있었습니다. RAID의 구현이 어렵지 않았던 것은 디스크의 실패-시-멈춤(fail-stop) 모델 때문이었습니다. 

빈번하게 발생하는 오류 중에 우리가 살펴볼만한 것은 두 가지 종류의 단일-블럭 오류가 있습니다. 각각은 숨어있는 섹터 에러(Latent sector error, LSE) 와 블럭 손상(block corruption)입니다. 각각에 대해서 좀 더 자세히 살펴보도록 하겠습니다.

LSE는 디스크 섹터 (또는 섹터 그룹)가 어떤 이유로든 손상되었을 때 발생합니다. 예를 들어, 디스크 헤드가 표면에 어떤 이유로 닿았다면 (헤드 크래시(head crash), 일반적인 상황에서는 일어나면 안 됨) 표면을 망가뜨릴 이고 비트들을 읽을 수 없게 만듭니다. 강한 방사선도 역시 비트를 반전시켜서 내용을 부정확하게 만들 수 있습니다. 다행스러운 것은 디스크 내의 에러 정정 코드(error correcting codes, ECC)를 사용하여 디스크상에 있는 블럭의 비트가 괜찮은지 판단하고 어떤 경우에는 고치기도 합니다. 어떤 비트의 상태가 좋지 않은데 그 부분의 에러를 고칠 충분한 정보를 갖고 있지 않다고 하자. 그때 해당 비트를 읽는 요청을 받으면 디스크는 에러를 리턴합니다. 

디스크가 손상 여부를 인식할 수 없게 내용이 손상(corrupt)된 경우입니다. 이 경우 해당 블럭의 내용은 읽혀집니다. 예를 들어, 버그가 있는 디스크 펌웨어 때문에 잘못된 위치에 쓰기를 했을 수 있습니다. 그 경우 디스크 ECC는 디스크의 내용이 정상이라고 표시하지만 사용자가 추후 해당 블럭을 읽을 때, 잘못된 블럭이 리턴됩니다. 이전에 쓴 자료는 엉뚱한 곳에 기록되었기 때문입니다. 마찬가지로 전송 버스 상에 오류로 인해서 호스트에서 디스크로 전송되는 도중에 블럭이 손상될 수도 있습니다. 손상된 데이터가 디스크에 저장이 됩니다. 사용자가 원하는 결과가 아니다. 이러한 종류의 오류들은 조용한 오류(silent fault)이기 때문에 더 심각합니다. 오류가 있는 데이터를 리턴함에도 불구하고, 디스크는 문제를 전혀 알리지 않습니다.

|            |저가     |고가       |  
|LSE         |0.094   |0.014      |
|블럭 손상    |0.005   |0.0005     |

이 두 종류의 오류는 정확히 얼마나 드물게 발생할까? 위에 두 편의 Bairava-sundaram의 연구에서 발견한 결과를 정리하였습니다. 관측 기간 동안 최소한 하나의 LSE 또는 블럭 손상이 보인 드라이브들의 백분율을 나타냅니다. 디스크의 가격대에 따라 “저가” 그리고 “고가”으로 나누어 표현했습니다. 더 좋은 드라이브를 구매하는 이 두 문제의 발생 빈도를 낮춘다는 을 알 수 있습니다. 저장 시스템에서 이러한 경우를 다루는 방법을 생각해야 할 만큼 충분히 많이 발생하고 있다는 것을 보여줍니다. 

LSE에 대해 다음과 같은 현상이 발견되었습니다.
- 하나 이상의 LSE를 갖고 있는 고가의 드라이브들은 저가의 드라이브들처럼 추가적인 에러를 만들어 냅니다.
- 대부분의 드라이브들의 연간 에러율은 둘째 해에 증가합니다.
- LSE는 디스크의 크기에 비례하여 증가합니다.
- LSE를 갖고 있는 대부분의 디스크는 50개 미만의 LSE를 갖고 있습니다.
- LSE를 갖고 있는 디스크들은 추가적인 LSE를 만들어 낼 확률이 있습니다.
- 공간과 시간 지역성이 상당히 두드러집니다.
- 디스크를 지우는 잃이 유용합니다 (이것으로 대부분의 LSE를 발견할 수 있습니다).

“섹터 손상”에 대해서 다음과 같은 특성이 관찰되었습니다.
- 같은 급의 드라이브들이라고 하더라도 모델에 따라서 손상 확률의 차이가 큽니다.
- 사용 연한에 따른 영향은 모델에 따라 다릅니다.
- 워크로드와 디스크의 크기는 섹터 손상 빈도에 큰 영향이 없습니다.
- 섹터 손상이 발생한 대부분의 디스크는 단지 몇 개의 손상된 부분을 갖고 있습니다.
- RAID로 묶인 디스크들 간이나 하나의 디스크에 있는 손상은 독립적이지 않습니다.
- LSE와는 연관성이 약합니다.

이 오류을에 들에 대해서 더 자세히 알고 싶다면 해당 논문을 읽어보기 바랍니다. 만약 신뢰할 수 있는 저장 시스템을 만들고 싶다면, LSE와 블럭 손상을 검출하고 복구할 수 있는 기술을 포함해야 합니다.

## 숨어있는 섹터 에러 (Latent Sector Error)

디스크의 부분 오류 (partial failure) 두 가지에 대해 알았으니 대처 방법을 알아봅시다. 먼저 둘 중에 더 쉬운 주제인 숨어있는 섹터 에러를 해결해 봅시다.

숨어있는 섹터 에러는 쉽게 발견할 수 있기 때문에 해결이 어렵지 않습니다. 저장 시스템의 임의의 블럭을 접근할 때 디스크가 에러를 리턴한다면 저장 시스템은 어떤 식으로든 중복 정보를 저장하여 제대로된 데이터를 리턴해야 합니다. 미러링 RAID의 경우에서는 사본을 보관합니다. 패리티를 기반으로 하는 RAID-4와 RAID-5 시스템의 경우에는 패리티 그룹내의 다른 블럭들을 활용하여 해당 블럭을 재생성합니다. 결론적으로 LSE처럼 쉽게 발견 가능한 문제에서는 잘 알려진 중복 정보를 이용한 복구 기법들이 존재하며, 이들 중복 기법들을 통해서 손쉽게 복구 할 수 있습니다. 

LSE가 점차 빈번해 지면서 수년 간 RAID의 설계에 변화가 왔습니다. RAID-4/5 시스템에서 발생할 수 있는 한 가지 흥미로운 문제는 하나의 디스크가 완전히 고장이 나면서 동시에 다른 디스크에서 LSE가 발생하는 경우입니다. 어떤 디스크가 완전히 고장이 나면 RAID는 패리티 그룹 내의 모든 다른 디스크들을 읽어서 빠진 값을 다시 계산하여 디스크 재구성(reconstruct)을 시도합니다. 만약에 재구성하는 도중에 다른 디스크들 중 하나에서 LSE를 만나면, 문제가 발생합니다. 그러면 재구성이 실패하게 됩니다. 

이 문제를 해결하기 위해서 어떤 시스템들은 추가적인 기법을 도했습니다. 예를 들면, NetApp의 RAID-DP는 두 개의 패리티 디스크를 사용합니다. 재구성 도중에 LSE가 발생하면 추가적인 패리티가 블럭을 재구성하는 데 도움을 줍니다. 항상 그렇듯이 추가 비용이 발생합니다. 각 스트라이프에 두 개의 패리티 블럭을 유지한다는 잃은 큰 비용입니다. 하지만 로그 기반의 구조를 갖는 NetApp의 WAFL 파일 시스템은 그러한 비용을 여러 측면으로 완화시켰습니다. 마지막으로 남은 비용은 공간입니다. 추가적인 패리티 블럭을 구성하기 위해 추가 디스크가 필요합니다. 

## 손상 검출 : 체크섬

## 체크섬의 활용

## 새로운 문제 : 잘못된 위치에 기록

## 마지막 문제 : 기록 작업의 손실

## Scrubbing

## 체크섬 오버헤드

## 요약
